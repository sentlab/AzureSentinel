{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Zscaler",
    "comments": "Solution template for Zscaler Internet Access"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Zscaler Firewall",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook2-name": {
      "type": "string",
      "defaultValue": "Zscaler Office365 Apps",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook3-name": {
      "type": "string",
      "defaultValue": "Zscaler Threats",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook4-name": {
      "type": "string",
      "defaultValue": "Zscaler Web Overview",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "solutionId": "zscaler1579058425289.zscaler_internet_access_mss",
    "_solutionId": "[variables('solutionId')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "uiConfigId1": "Zscaler",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "Zscaler",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1')))]",
    "dataConnectorVersion1": "1.0.0",
    "TemplateEmptyArray": "[json('[]')]",
    "workbookVersion1": "1.1.0",
    "workbookContentId1": "ZscalerFirewallWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1')))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workbookVersion2": "1.1.0",
    "workbookContentId2": "ZscalerOffice365AppsWorkbook",
    "workbookId2": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId2'))]",
    "workbookTemplateSpecName2": "[concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId2')))]",
    "_workbookContentId2": "[variables('workbookContentId2')]",
    "workbookVersion3": "1.2.0",
    "workbookContentId3": "ZscalerThreatsOverviewWorkbook",
    "workbookId3": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId3'))]",
    "workbookTemplateSpecName3": "[concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId3')))]",
    "_workbookContentId3": "[variables('workbookContentId3')]",
    "workbookVersion4": "1.1.0",
    "workbookContentId4": "ZscalerWebOverviewWorkbook",
    "workbookId4": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId4'))]",
    "workbookTemplateSpecName4": "[concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId4')))]",
    "_workbookContentId4": "[variables('workbookContentId4')]",
    "analyticRuleVersion1": "1.0.0",
    "analyticRulecontentId1": "010bd98c-a6be-498c-bdcd-502308c0fdae",
    "_analyticRulecontentId1": "[variables('analyticRulecontentId1')]",
    "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId1'))]",
    "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId1')))]",
    "analyticRuleVersion2": "1.0.1",
    "analyticRulecontentId2": "4d500e6d-c984-43a3-9f39-7edec8dcc04d",
    "_analyticRulecontentId2": "[variables('analyticRulecontentId2')]",
    "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId2'))]",
    "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId2')))]",
    "parserVersion1": "1.0.0",
    "parserContentId1": "ZScalerFW_Parser-Parser",
    "_parserContentId1": "[variables('parserContentId1')]",
    "parserName1": "ZScalerFW_Parser",
    "_parserName1": "[concat(parameters('workspace'),'/',variables('parserName1'))]",
    "parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
    "_parserId1": "[variables('parserId1')]",
    "parserTemplateSpecName1": "[concat(parameters('workspace'),'-pr-',uniquestring(variables('_parserContentId1')))]",
    "parserVersion2": "1.0.0",
    "parserContentId2": "ZScalerWeb_Parser-Parser",
    "_parserContentId2": "[variables('parserContentId2')]",
    "parserName2": "ZScalerWeb_Parser",
    "_parserName2": "[concat(parameters('workspace'),'/',variables('parserName2'))]",
    "parserId2": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName2'))]",
    "_parserId2": "[variables('parserId2')]",
    "parserTemplateSpecName2": "[concat(parameters('workspace'),'-pr-',uniquestring(variables('_parserContentId2')))]",
    "FunctionApp": "FunctionApp",
    "_FunctionApp": "[variables('FunctionApp')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "FunctionApp",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'-fa-',uniquestring(variables('_playbookContentId1')))]",
    "Zscaler API authentication": "Zscaler API authentication",
    "_Zscaler API authentication": "[variables('Zscaler API authentication')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "Zscaler API authentication",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2')))]",
    "blanks": "[replace('b', 'b', '')]",
    "Add-Url-To-Category": "Add-Url-To-Category",
    "_Add-Url-To-Category": "[variables('Add-Url-To-Category')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "Add-Url-To-Category",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3')))]",
    "Get-Sandbox-Report-For-Hash": "Get-Sandbox-Report-For-Hash",
    "_Get-Sandbox-Report-For-Hash": "[variables('Get-Sandbox-Report-For-Hash')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "Get-Sandbox-Report-For-Hash",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "properties": {
        "description": "Zscaler Internet Access data connector with template",
        "displayName": "Zscaler Internet Access template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('dataConnectorTemplateSpecName1'),'/',variables('dataConnectorVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('dataConnectorTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "Zscaler Internet Access data connector with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "Zscaler",
                  "publisher": "Zscaler",
                  "logo": "ZscalerLogo.svg",
                  "descriptionMarkdown": "The Zscaler data connector allows you to easily connect your Zscaler Internet Access (ZIA) logs with Microsoft Sentinel, to view dashboards, create custom alerts, and improve investigation.  Using Zscaler on Microsoft Sentinel will provide you more insights into your organization’s Internet usage, and will enhance its security operation capabilities.​",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "Zscaler",
                      "baseQuery": "\nCommonSecurityLog\n| where DeviceVendor == \"Zscaler\"\n"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "query": "\nCommonSecurityLog\n| where DeviceVendor == \"Zscaler\"\n\n            | sort by TimeGenerated"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "\nCommonSecurityLog\n| where DeviceVendor == \"Zscaler\"\n\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog (Zscaler)",
                      "lastDataReceivedQuery": "\nCommonSecurityLog\n| where DeviceVendor == \"Zscaler\"\n\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "read": true,
                          "write": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": "Install and configure the Linux agent to collect your Common Event Format (CEF) Syslog messages and forward them to Microsoft Sentinel.\n\n> Notice that the data from all regions will be stored in the selected workspace",
                      "innerSteps": [
                        {
                          "title": "1.1 Select or create a Linux machine",
                          "description": "Select or create a Linux machine that Microsoft Sentinel will use as the proxy between your security solution and Microsoft Sentinel this machine can be on your on-prem environment, Azure or other clouds."
                        },
                        {
                          "title": "1.2 Install the CEF collector on the Linux machine",
                          "description": "Install the Microsoft Monitoring Agent on your Linux machine and configure the machine to listen on the necessary port and forward messages to your Microsoft Sentinel workspace. The CEF collector collects CEF messages on port 514 TCP.\n\n> 1. Make sure that you have Python on your machine using the following command: python --version.\n\n> 2. You must have elevated permissions (sudo) on your machine.",
                          "instructions": [
                            {
                              "parameters": {
                                "fillWith": [
                                  "WorkspaceId",
                                  "PrimaryKey"
                                ],
                                "label": "Run the following command to install and apply the CEF collector:",
                                "value": "sudo wget -O cef_installer.py https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/DataConnectors/CEF/cef_installer.py&&sudo python cef_installer.py {0} {1}"
                              },
                              "type": "CopyableLabel"
                            }
                          ]
                        }
                      ],
                      "title": "1. Linux Syslog agent configuration"
                    },
                    {
                      "description": "Set Zscaler product to send Syslog messages in CEF format to your Syslog agent. Make sure you to send the logs on port 514 TCP. \n\nGo to [Zscaler Sentinel integration guide](https://aka.ms/ZscalerCEFInstructions) to learn more.",
                      "title": "2. Forward Common Event Format (CEF) logs to Syslog agent"
                    },
                    {
                      "description": "Follow the instructions to validate your connectivity:\n\nOpen Log Analytics to check if the logs are received using the CommonSecurityLog schema.\n\n>It may take about 20 minutes until the connection streams data to your workspace.\n\nIf the logs are not received, run the following connectivity validation script:\n\n> 1. Make sure that you have Python on your machine using the following command: python --version\n\n>2. You must have elevated permissions (sudo) on your machine",
                      "instructions": [
                        {
                          "parameters": {
                            "fillWith": [
                              "WorkspaceId"
                            ],
                            "label": "Run the following command to validate your connectivity:",
                            "value": "sudo wget -O cef_troubleshoot.py https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/DataConnectors/CEF/cef_troubleshoot.py&&sudo python cef_troubleshoot.py  {0}"
                          },
                          "type": "CopyableLabel"
                        }
                      ],
                      "title": "3. Validate connection"
                    },
                    {
                      "description": "Make sure to configure the machine's security according to your organization's security policy\n\n\n[Learn more >](https://aka.ms/SecureCEF)",
                      "title": "4. Secure your machine "
                    }
                  ],
                  "metadata": {
                    "id": "4621323a-6201-4731-966c-012e4f2505be",
                    "version": "1.0.0",
                    "kind": "dataConnector",
                    "source": {
                      "kind": "community"
                    },
                    "author": {
                      "name": "Zscaler"
                    },
                    "support": {
                      "name": "Zscaler",
                      "link": "https://help.zscaler.com/submit-ticket-links",
                      "tier": "developer"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Zscaler"
                },
                "support": {
                  "name": "Zscaler",
                  "tier": "Partner",
                  "link": "https://help.zscaler.com/submit-ticket-links"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Zscaler Internet Access",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Zscaler"
        },
        "support": {
          "name": "Zscaler",
          "tier": "Partner",
          "link": "https://help.zscaler.com/submit-ticket-links"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Zscaler",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The Zscaler data connector allows you to easily connect your Zscaler Internet Access (ZIA) logs with Microsoft Sentinel, to view dashboards, create custom alerts, and improve investigation.  Using Zscaler on Microsoft Sentinel will provide you more insights into your organization’s Internet usage, and will enhance its security operation capabilities.​",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "Zscaler",
              "baseQuery": "\nCommonSecurityLog\n| where DeviceVendor == \"Zscaler\"\n"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog (Zscaler)",
              "lastDataReceivedQuery": "\nCommonSecurityLog\n| where DeviceVendor == \"Zscaler\"\n\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "\nCommonSecurityLog\n| where DeviceVendor == \"Zscaler\"\n\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "query": "\nCommonSecurityLog\n| where DeviceVendor == \"Zscaler\"\n\n            | sort by TimeGenerated"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "read": true,
                  "write": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "description": "Install and configure the Linux agent to collect your Common Event Format (CEF) Syslog messages and forward them to Microsoft Sentinel.\n\n> Notice that the data from all regions will be stored in the selected workspace",
              "innerSteps": [
                {
                  "title": "1.1 Select or create a Linux machine",
                  "description": "Select or create a Linux machine that Microsoft Sentinel will use as the proxy between your security solution and Microsoft Sentinel this machine can be on your on-prem environment, Azure or other clouds."
                },
                {
                  "title": "1.2 Install the CEF collector on the Linux machine",
                  "description": "Install the Microsoft Monitoring Agent on your Linux machine and configure the machine to listen on the necessary port and forward messages to your Microsoft Sentinel workspace. The CEF collector collects CEF messages on port 514 TCP.\n\n> 1. Make sure that you have Python on your machine using the following command: python --version.\n\n> 2. You must have elevated permissions (sudo) on your machine.",
                  "instructions": [
                    {
                      "parameters": {
                        "fillWith": [
                          "WorkspaceId",
                          "PrimaryKey"
                        ],
                        "label": "Run the following command to install and apply the CEF collector:",
                        "value": "sudo wget -O cef_installer.py https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/DataConnectors/CEF/cef_installer.py&&sudo python cef_installer.py {0} {1}"
                      },
                      "type": "CopyableLabel"
                    }
                  ]
                }
              ],
              "title": "1. Linux Syslog agent configuration"
            },
            {
              "description": "Set Zscaler product to send Syslog messages in CEF format to your Syslog agent. Make sure you to send the logs on port 514 TCP. \n\nGo to [Zscaler Sentinel integration guide](https://aka.ms/ZscalerCEFInstructions) to learn more.",
              "title": "2. Forward Common Event Format (CEF) logs to Syslog agent"
            },
            {
              "description": "Follow the instructions to validate your connectivity:\n\nOpen Log Analytics to check if the logs are received using the CommonSecurityLog schema.\n\n>It may take about 20 minutes until the connection streams data to your workspace.\n\nIf the logs are not received, run the following connectivity validation script:\n\n> 1. Make sure that you have Python on your machine using the following command: python --version\n\n>2. You must have elevated permissions (sudo) on your machine",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Run the following command to validate your connectivity:",
                    "value": "sudo wget -O cef_troubleshoot.py https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/DataConnectors/CEF/cef_troubleshoot.py&&sudo python cef_troubleshoot.py  {0}"
                  },
                  "type": "CopyableLabel"
                }
              ],
              "title": "3. Validate connection"
            },
            {
              "description": "Make sure to configure the machine's security according to your organization's security policy\n\n\n[Learn more >](https://aka.ms/SecureCEF)",
              "title": "4. Secure your machine "
            }
          ],
          "id": "[variables('_uiConfigId1')]"
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "properties": {
        "description": "Zscaler Internet Access Workbook with template",
        "displayName": "Zscaler Internet Access workbook template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('workbookTemplateSpecName1'),'/',variables('workbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('workbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "ZscalerFirewallWorkbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Gain insights into your ZIA cloud firewall logs by connecting to Microsoft Sentinel.\nThe Zscaler firewall overview workbook provides an overview and ability to drill down into all cloud firewall activity in your Zscaler instance including non-web related networking events, security events, firewall rules, and bandwidth consumption"
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler Firewall Overview\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"query\":\"\",\"crossComponentResources\":\"[variables('TemplateEmptyArray')]\",\"parameters\":[{\"id\":\"ff5a2a6c-cf01-432a-ab49-e59918ead8ab\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":86400000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}},{\"id\":\"fe452f11-ddc9-4b85-b441-b8f6be3b33a8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SourceIP\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where SourceTranslatedAddress  != \\\"\\\" \\r\\n| summarize Count = count() by SourceTranslatedAddress\\r\\n| project Value = SourceTranslatedAddress, Label = strcat(SourceTranslatedAddress, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"d5fa439b-b1d7-491e-8953-5e4f7bf74f81\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SourcePort\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\")\\r\\n| where SourcePort  != \\\"\\\" \\r\\n| summarize Count = count() by SourcePort\\r\\n| project Value = SourcePort, Label = strcat(\\\"Port: \\\",SourcePort, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"2f749931-c232-471f-b91f-f91514fd7fa7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DestinationIP\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where DestinationIP  != \\\"\\\" \\r\\n| summarize Count = count() by DestinationIP\\r\\n| project Value = DestinationIP, Label = strcat(DestinationIP, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"5ecf989b-46cc-4cde-80fb-720d1ad2a5e2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DestinationPort\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\"\\r\\n| where DestinationPort  != \\\"\\\" \\r\\n| summarize Count = count() by DestinationPort\\r\\n| project Value = DestinationPort, Label = strcat(DestinationPort, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":1,\"content\":{\"json\":\"### Block actions\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| summarize Count = count() by Protocol\\r\\n| sort by Count desc\\r\\n| top 10 by Count\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked protocols\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where SourceUserPrivileges == SourceUserName\\r\\n| summarize Count = count() by SourceUserName\\r\\n| sort by Count desc\\r\\n| top 10 by Count\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked locations\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where DestinationPort   != \\\"0\\\" \\r\\n| extend dst_port = tostring(DestinationPort) \\r\\n| summarize Count = count() by  dst_port\\r\\n| top 10 by Count desc nulls last \",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked destination ports\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where DestinationIP != \\\"\\\" \\r\\n| summarize Count = count() by DestinationIP\\r\\n| sort by Count desc\\r\\n| top 10 by Count\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked destination IP addresses\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where SourceTranslatedAddress  != \\\"\\\" \\r\\n| summarize Count = count() by SourceTranslatedAddress\\r\\n| sort by Count desc\\r\\n| top 10 by Count\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked source IP addresses\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where SourcePort   != \\\"0\\\" \\r\\n| extend src_port = tostring(SourcePort) \\r\\n| summarize Count = count() by  src_port\\r\\n| order by Count\\r\\n| take 10\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked source ports\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 12\"},{\"type\":1,\"content\":{\"json\":\"---\"},\"name\":\"text - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| summarize ['Recived MB'] = sum(ReceivedBytes/1024.0/1024.0), ['Sent MB'] = sum(SentBytes/1024.0/1024.0) by bin(TimeGenerated, {TimeRange:grain}), SourceUserPrivileges\\r\\n| project-rename Location = SourceUserPrivileges \\r\\n| order by ['Recived MB'] desc, ['Sent MB'] desc\",\"size\":0,\"exportFieldName\":\"\",\"exportParameterName\":\"LocationFilter\",\"exportDefaultValue\":\"{\\\"Location\\\":\\\"*\\\"}\",\"exportToExcelOptions\":\"visible\",\"title\":\"Non-http downloads and uploads in MB\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"formatOptions\":{\"min\":0,\"palette\":\"turquoise\",\"showIcon\":true}},{\"columnMatch\":\"Location\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Recived MB\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"purple\",\"showIcon\":true,\"aggregation\":\"Sum\"}},{\"columnMatch\":\"Sent MB\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"magenta\",\"showIcon\":true,\"aggregation\":\"Sum\"}},{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}}],\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Location\"],\"expandTopLevel\":false,\"finalBy\":\"Location\"},\"labelSettings\":\"[variables('TemplateEmptyArray')]\"}},\"customWidth\":\"50\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| summarize ['Recived MB'] = sum(ReceivedBytes/1024.0/1024.0), ['Sent MB'] = sum(SentBytes/1024.0/1024.0) by bin(TimeGenerated, {TimeRange:grain}), SourceUserPrivileges\\r\\n| project-rename Location = SourceUserPrivileges \\r\\n| where Location == dynamic({LocationFilter}).childRows[0].Location or dynamic({LocationFilter}).Location == Location or dynamic({LocationFilter}).Location == \\\"*\\\"\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Non-http downloads and uploads in MB\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where Activity !contains \\\"Default\\\"  and Activity !contains \\\"Recommended\\\" \\r\\n| summarize count()  by bin(TimeGenerated, {TimeRange:grain}), Activity \",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Non-default firewall rules getting triggered\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"name\":\"query - 11\"}],\"fromTemplateId\":\"sentinel-ZscalerFirewallOverview\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=ZscalerFirewallWorkbook; logoFileName=zscaler_logo.svg; description=Gain insights into your ZIA cloud firewall logs by connecting to Microsoft Sentinel.\nThe Zscaler firewall overview workbook provides an overview and ability to drill down into all cloud firewall activity in your Zscaler instance including non-web related networking events, security events, firewall rules, and bandwidth consumption; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.1.0; title=Zscaler Firewall; templateRelativePath=ZscalerFirewall.json; subtitle=; provider=Zscaler}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Zscaler"
                },
                "support": {
                  "name": "Zscaler",
                  "tier": "Partner",
                  "link": "https://help.zscaler.com/submit-ticket-links"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "CommonSecurityLog",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "Zscaler",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('workbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "properties": {
        "description": "Zscaler Internet Access Workbook with template",
        "displayName": "Zscaler Internet Access workbook template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('workbookTemplateSpecName2'),'/',variables('workbookVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('workbookTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "ZscalerOffice365AppsWorkbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId2')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Gain insights into Office 365 use on your network.\nThe Zscaler Office 365 overview workbook shows you the Microsoft apps running on your network and their individual bandwidth consumption. It also helps identify phishing attempts in which attackers disguised themselves as Microsoft services."
              },
              "properties": {
                "displayName": "[parameters('workbook2-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler Office 365 overview\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"query\":\"\",\"crossComponentResources\":\"[variables('TemplateEmptyArray')]\",\"parameters\":[{\"id\":\"ff5a2a6c-cf01-432a-ab49-e59918ead8ab\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":259200000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DestinationServiceName contains \\\"Microsoft\\\" or DestinationServiceName contains  \\\"Skype\\\"  or DestinationServiceName contains \\\"Sharepoint\\\" or DestinationServiceName contains \\\"Onedrive\\\"  or DestinationServiceName contains \\\"Outlook\\\" or DestinationServiceName contains \\\"office.com\\\"\\r\\n| where DeviceEventClassID contains \\\"Allow\\\" \\r\\n| summarize count()  by bin(TimeGenerated, {TimeRange:grain}), DestinationServiceName\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Microsoft services activity over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DestinationServiceName contains \\\"Microsoft\\\" or DestinationServiceName contains  \\\"Skype\\\"  or DestinationServiceName contains \\\"Sharepoint\\\" or DestinationServiceName contains \\\"Onedrive\\\"  or DestinationServiceName contains \\\"Outlook\\\" or DestinationServiceName contains \\\"office.com\\\"\\r\\n| where DeviceEventClassID contains \\\"Allow\\\" \\r\\n| summarize BW_usage_MB = sum((ReceivedBytes+SentBytes)/1024.0/1024.0)  by bin(TimeGenerated, {TimeRange:grain}),  SourceUserPrivileges\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"BW consumption, by Microsoft apps (based on Location)\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DestinationServiceName contains \\\"Microsoft\\\" or DestinationServiceName contains  \\\"Skype\\\"  or DestinationServiceName contains \\\"Sharepoint\\\" or DestinationServiceName contains \\\"Onedrive\\\"  or DestinationServiceName contains \\\"Outlook\\\" or DestinationServiceName contains \\\"office.com\\\"\\r\\n| where DeviceEventClassID contains \\\"Allow\\\" \\r\\n| summarize sum((ReceivedBytes+SentBytes)/1024.0/1024.0)  by bin(TimeGenerated, {TimeRange:grain}),  DestinationServiceName\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"BW consumption, by Microsoft Apps (based on App)\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DestinationServiceName contains \\\"Microsoft\\\" or DestinationServiceName contains  \\\"Skype\\\"  or DestinationServiceName contains \\\"Sharepoint\\\" or DestinationServiceName contains \\\"Onedrive\\\"  or DestinationServiceName contains \\\"Outlook\\\" or DestinationServiceName contains \\\"office.com\\\"\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where DeviceCustomString2 == \\\"Phishing\\\"\\r\\n| summarize count()  by bin(TimeGenerated, {TimeRange:grain}), DestinationServiceName\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Phishing attempts disguised as Microsoft services\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"DestinationServiceName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 5\"}],\"fromTemplateId\":\"sentinel-ZscalerOffice365Apps\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId2'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=ZscalerOffice365AppsWorkbook; logoFileName=zscaler_logo.svg; description=Gain insights into Office 365 use on your network.\nThe Zscaler Office 365 overview workbook shows you the Microsoft apps running on your network and their individual bandwidth consumption. It also helps identify phishing attempts in which attackers disguised themselves as Microsoft services.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.1.0; title=Zscaler Office365 Apps; templateRelativePath=ZscalerOffice365Apps.json; subtitle=; provider=Zscaler}.description",
                "parentId": "[variables('workbookId2')]",
                "contentId": "[variables('_workbookContentId2')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Zscaler"
                },
                "support": {
                  "name": "Zscaler",
                  "tier": "Partner",
                  "link": "https://help.zscaler.com/submit-ticket-links"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "CommonSecurityLog",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "Zscaler",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('workbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "properties": {
        "description": "Zscaler Internet Access Workbook with template",
        "displayName": "Zscaler Internet Access workbook template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('workbookTemplateSpecName3'),'/',variables('workbookVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('workbookTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "ZscalerThreatsWorkbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId3')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Gain insights into threats blocked by Zscaler Internet access on your network.\nThe Zscaler threat overview workbook shows your entire threat landscape including blocked malware, IPS/AV rules, and blocked cloud apps. Threats are displayed by threat categories, filetypes, inbound vs outbound threats, usernames, user location, and more."
              },
              "properties": {
                "displayName": "[parameters('workbook3-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler Threats Overview\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"e6ceec81-0d4d-420e-8ed3-062a7eb4129a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":604800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID == \\\"Blocked\\\"\\r\\n| where DeviceCustomString5Label == \\\"threatname\\\" \\r\\n| where DeviceCustomString5 != \\\"None\\\" \\r\\n| where DeviceCustomString5 != \\\"suspiciousfile\\\" \\r\\n| summarize Count = count() by ['Threat name'] = DeviceCustomString5, threatname = DeviceCustomString5\\r\\n| order by Count desc\",\"size\":0,\"exportFieldName\":\"threatname\",\"exportParameterName\":\"threatname\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked threats\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Threat name\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"threatname\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\",\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"30\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID == \\\"Blocked\\\"\\r\\n| where DeviceCustomString5Label == \\\"threatname\\\" \\r\\n| where DeviceCustomString5 != \\\"None\\\" \\r\\n| where DeviceCustomString5 != \\\"suspiciousfile\\\"\\r\\n| where '{threatname}' == \\\"All\\\" or '{threatname}' == DeviceCustomString5 \\r\\n| summarize count() by bin(TimeGenerated, {TimeRange:grain}), ['Threat name'] = DeviceCustomString5\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked threats over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"70\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID contains \\\"Block\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where DeviceCustomString2 != \\\"\\\"\\r\\n| summarize Count = count() by urlcat = DeviceCustomString2\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"exportFieldName\":\"urlcat\",\"exportParameterName\":\"urlcat\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked URL categories\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"urlcat\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"greenRed\",\"showIcon\":true}}],\"filter\":true,\"labelSettings\":[{\"columnId\":\"urlcat\",\"label\":\"URL categories\"},{\"columnId\":\"Count\",\"label\":\"\"}]}},\"customWidth\":\"30\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID contains \\\"Block\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where DeviceCustomString2 != \\\"\\\"\\r\\n| where '{urlcat}' == \\\"All\\\" or '{urlcat}' == DeviceCustomString2\\r\\n| summarize Count = count() by urlcat = DeviceCustomString2, bin(TimeGenerated, {TimeRange:grain})\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked URL categories over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"70\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID == \\\"Blocked\\\"\\r\\n| where Activity contains \\\"IPS\\\" \\r\\n| summarize Count = count()  by  Activity\\r\\n| order by Count desc\",\"size\":0,\"exportFieldName\":\"Activity\",\"exportParameterName\":\"Activity\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Transactions blocked IPS\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Activity\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\",\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"30\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID == \\\"Blocked\\\"\\r\\n| where Activity contains \\\"IPS\\\" \\r\\n| where Activity == '{Activity}' or '{Activity}' == \\\"All\\\"\\r\\n| summarize Count = count()  by  Activity, bin(TimeGenerated, {TimeRange:grain})\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Transactions blocked IPS over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Activity\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"SourceIP\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true,\"aggregation\":\"Unique\"}},{\"columnMatch\":\"DestinationIP\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true,\"aggregation\":\"Unique\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orangeBlue\",\"showIcon\":true,\"aggregation\":\"Sum\"}},{\"columnMatch\":\"count_\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true,\"aggregation\":\"Sum\"}},{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Activity\",\"SourceIP\",\"DestinationIP\"]}}},\"customWidth\":\"70\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where SourceUserPrivileges != SourceUserName \\r\\n| extend DeviceCustomNumber1 = coalesce(column_ifexists(\\\"FieldDeviceCustomNumber1\\\", long(null)),DeviceCustomNumber1)\\r\\n | where DeviceCustomNumber1>=50\\r\\n| summarize Count = count() by SourceUserName, RiskScore = DeviceCustomNumber1\\r\\n| order by RiskScore desc, Count\",\"size\":0,\"exportFieldName\":\"SourceUserName\",\"exportParameterName\":\"SourceUserName\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Users accessing malicious destinations\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SourceUserName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"RiskScore\",\"formatter\":8,\"formatOptions\":{\"min\":50,\"palette\":\"greenRed\",\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"30\",\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where SourceUserPrivileges != SourceUserName \\r\\n| where SourceUserName == '{SourceUserName}' or '{SourceUserName}' == \\\"All\\\"\\r\\n| where DeviceCustomNumber1>=50\\r\\n| summarize count() by bin(TimeGenerated, {TimeRange:grain}), SourceUserName\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Users accessing malicious destinations over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"70\",\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID == \\\"Blocked\\\"\\r\\n| where FileType != \\\"None\\\" \\r\\n| summarize count() by FileType \\r\\n| sort by count_  desc nulls last \\r\\n| top 10 by count_\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked file types\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n|  where DeviceCustomString4 !=\\\"None\\\"\\r\\n| summarize count() by malwarecat = DeviceCustomString4\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Transactions intercepted by malware protection\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"malwarecat\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"count_\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}}],\"labelSettings\":[{\"columnId\":\"malwarecat\",\"label\":\"Malware Categoty\"},{\"columnId\":\"count_\"}]}},\"customWidth\":\"33\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| extend DeviceCustomNumber1 = coalesce(column_ifexists(\\\"FieldDeviceCustomNumber1\\\", long(null)),DeviceCustomNumber1)\\r\\n| where DeviceCustomNumber1 != 0\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where DeviceCustomString4 !=\\\"None\\\"\\r\\n| where RequestMethod == \\\"GET\\\"  or  RequestMethod == \\\"POST\\\"\\r\\n| extend replaced= iif ( RequestMethod==\\\"GET\\\" , replace('GET', 'Inbound Threats', RequestMethod) , replace('POST', 'Outbound Threats', RequestMethod))\\r\\n| summarize count() by  replaced\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Inbound and outbound blocked threats\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"replaced\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"33\",\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| parse AdditionalExtensions with * \\\"urlclass=\\\" urlclass \\\";devicemodel=\\\" devicemodel\\r\\n| where urlclass == \\\"Advanced Security Risk\\\" \\r\\n| summarize count() by urlcat = DeviceCustomString2\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked advanced security risk URL categories\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n|  where DeviceCustomString4 !=\\\"None\\\"\\r\\n| where SourceUserPrivileges == \\\"Road Warrior\\\" \\r\\n| summarize count() by malwarecat = DeviceCustomString4\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Threats blocked for Road Warriors\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 14\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceCustomString3 contains \\\"Behavior\\\" \\r\\n| summarize count() by malwarecat = DeviceCustomString4\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Threats intercepted by Sandbox protection\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 15\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where DeviceEventClassID contains \\\"Block\\\"\\r\\n| where MaliciousIPCountry !=\\\"\\\";\\r\\nlet appData = data\\r\\n| summarize TotalCount = count() by MaliciousIPCountry\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by MaliciousIPCountry\\r\\n    | project-away TimeGenerated) on MaliciousIPCountry\\r\\n| order by TotalCount desc, MaliciousIPCountry asc\\r\\n| project MaliciousIPCountry, TotalCount, Trend\\r\\n| serialize Id = row_number();\\r\\ndata\\r\\n| summarize TotalCount = count() by Activity , MaliciousIPCountry\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by MaliciousIPCountry, Activity\\r\\n    | project-away TimeGenerated) on MaliciousIPCountry, Activity\\r\\n| order by TotalCount desc, MaliciousIPCountry asc\\r\\n| project MaliciousIPCountry, Activity, TotalCount, Trend\\r\\n| serialize Id = row_number(1000000)\\r\\n| join kind=inner (appData) on MaliciousIPCountry\\r\\n| project Id, Name = Activity, Type = 'Activity', ['MaliciousIPCountry Count'] = TotalCount, Trend,  ParentId = Id1\\r\\n| union (appData \\r\\n    | project Id, Name = MaliciousIPCountry, Type = 'Operation', ['MaliciousIPCountry Count'] = TotalCount,  Trend)\\r\\n| order by ['MaliciousIPCountry Count'] desc, Name asc\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked destination activities, by location\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Name\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Type\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"MaliciousIPCountry Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orangeRed\",\"showIcon\":true}},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"grayBlue\",\"showIcon\":true}},{\"columnMatch\":\"ParentId\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true,\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Name\"}}},\"customWidth\":\"50\",\"name\":\"query - 16\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where DestinationServiceName != \\\"generalbrowsing\\\"\\r\\n| summarize count() by DestinationServiceName, bin(TimeGenerated, {TimeRange:grain})\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked cloud apps over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"query - 17\"}],\"fromTemplateId\":\"sentinel-ZscalerThreats\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId3'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=ZscalerThreatsOverviewWorkbook; logoFileName=zscaler_logo.svg; description=Gain insights into threats blocked by Zscaler Internet access on your network.\nThe Zscaler threat overview workbook shows your entire threat landscape including blocked malware, IPS/AV rules, and blocked cloud apps. Threats are displayed by threat categories, filetypes, inbound vs outbound threats, usernames, user location, and more.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.2.0; title=Zscaler Threats; templateRelativePath=ZscalerThreats.json; subtitle=; provider=Zscaler}.description",
                "parentId": "[variables('workbookId3')]",
                "contentId": "[variables('_workbookContentId3')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Zscaler"
                },
                "support": {
                  "name": "Zscaler",
                  "tier": "Partner",
                  "link": "https://help.zscaler.com/submit-ticket-links"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "CommonSecurityLog",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "Zscaler",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('workbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "properties": {
        "description": "Zscaler Internet Access Workbook with template",
        "displayName": "Zscaler Internet Access workbook template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('workbookTemplateSpecName4'),'/',variables('workbookVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('workbookTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "ZscalerWebOverviewWorkbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion4')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId4')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Gain insights into your ZIA web logs by connecting to Microsoft Sentinel.\nThe Zscaler web overview workbook provides a bird's eye view and ability to drill down into all the security and networking events related to web transactions, types of devices, and bandwidth consumption."
              },
              "properties": {
                "displayName": "[parameters('workbook4-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler web overview\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"query\":\"\",\"crossComponentResources\":\"[variables('TemplateEmptyArray')]\",\"parameters\":[{\"id\":\"e246fdd8-f37f-4290-a205-7ffa192ea860\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":86400000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}},{\"id\":\"fe452f11-ddc9-4b85-b441-b8f6be3b33a8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SourceIP\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where SourceTranslatedAddress  != \\\"\\\" \\r\\n| summarize Count = count() by SourceTranslatedAddress\\r\\n| project Value = SourceTranslatedAddress, Label = strcat(SourceTranslatedAddress, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"2f749931-c232-471f-b91f-f91514fd7fa7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DestinationIP\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID  !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where DestinationIP  != \\\"\\\" \\r\\n| summarize Count = count() by DestinationIP\\r\\n| project Value = DestinationIP, Label = strcat(DestinationIP, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DestinationServiceName !=\\\"\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| summarize Count = count() by DestinationServiceName\\r\\n| order by Count desc\",\"size\":0,\"exportFieldName\":\"DestinationServiceName\",\"exportParameterName\":\"DestinationServiceNameFilter\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Apps being accessed\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DestinationServiceName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"palette\":\"purple\",\"showIcon\":true}}],\"filter\":true,\"labelSettings\":\"[variables('TemplateEmptyArray')]\"}},\"customWidth\":\"40\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DestinationServiceName !=\\\"\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where DestinationServiceName == '{DestinationServiceNameFilter}' or '{DestinationServiceNameFilter}' == \\\"All\\\"\\r\\n| summarize Count = count() by DestinationServiceName, bin(TimeGenerated, {TimeRange:grain})\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Apps being accessed over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"60\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceEventClassID contains \\\"Allow\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where DestinationServiceName has_any (\\\"Microsoft\\\", \\\"Skype\\\", \\\"SharePoint\\\", \\\"OneDrive\\\", \\\"Outlook\\\", \\\"office.com\\\", \\\"Sharepoint Online\\\", \\\"Microsoft Forms\\\", \\\"Microsoft Azure\\\")\\r\\n| summarize Count = count()  by DestinationServiceName\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Microsoft services\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DestinationServiceName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"greenBlue\",\"showIcon\":true}}],\"filter\":true,\"labelSettings\":\"[variables('TemplateEmptyArray')]\"}},\"customWidth\":\"50\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| parse AdditionalExtensions with * \\\"devicemodel=\\\" devicemodel\\r\\n| where devicemodel != \\\"\\\"  and    devicemodel !startswith \\\"NA\\\"\\r\\n| summarize count() by devicemodel \",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Devices\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceEventClassID == \\\"Allowed\\\" or DeviceEventClassID == \\\"Allow\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| summarize Downloads = sum( ReceivedBytes)/1024.0/1024.0 , Uploads = sum( SentBytes)/1024.0/1024.0 by Location = SourceUserPrivileges\",\"size\":0,\"exportFieldName\":\"Location\",\"exportParameterName\":\"LocationFilter\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Upload and download data in MB, by location - click to filter\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SourceUserPrivileges\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Downloads\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}},{\"columnMatch\":\"Uploads\",\"formatter\":4,\"formatOptions\":{\"palette\":\"green\",\"showIcon\":true}}],\"labelSettings\":\"[variables('TemplateEmptyArray')]\"}},\"customWidth\":\"50\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceEventClassID == \\\"Allowed\\\" or DeviceEventClassID == \\\"Allow\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where SourceUserPrivileges == '{LocationFilter}' or '{LocationFilter}' == \\\"All\\\"\\r\\n| summarize Downloads = sum( ReceivedBytes)/1024.0/1024.0 , Uploads = sum( SentBytes)/1024.0/1024.0 by bin(TimeGenerated, {TimeRange:grain}) \",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Upload and download data in MB over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where ApplicationProtocol !=\\\"\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\";\\r\\nlet appData = data\\r\\n| summarize TotalCount = count() by ApplicationProtocol\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by ApplicationProtocol\\r\\n    | project-away TimeGenerated) on ApplicationProtocol\\r\\n| order by TotalCount desc, ApplicationProtocol asc\\r\\n| project ApplicationProtocol, TotalCount, Trend\\r\\n| serialize Id = row_number();\\r\\ndata\\r\\n| summarize TotalCount = count() by RequestMethod , ApplicationProtocol\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by ApplicationProtocol, RequestMethod \\r\\n    | project-away TimeGenerated) on ApplicationProtocol, RequestMethod \\r\\n| order by TotalCount desc, ApplicationProtocol asc\\r\\n| project ApplicationProtocol, RequestMethod , TotalCount, Trend\\r\\n| serialize Id = row_number(1000000)\\r\\n| join kind=inner (appData) on ApplicationProtocol\\r\\n| project Id, Name = RequestMethod , Type = 'RequestMethod', ['ApplicationProtocol Count'] = TotalCount, Trend,  ParentId = Id1\\r\\n| union (appData \\r\\n    | project Id, Name = ApplicationProtocol, Type = 'ApplicationProtocol', ['ApplicationProtocol Count'] = TotalCount,  Trend)\\r\\n| order by ['ApplicationProtocol Count'] desc, Name asc\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Protocols and methods\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Name\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Type\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"ApplicationProtocol Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"gray\",\"showIcon\":true}},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blueDark\",\"showIcon\":true}},{\"columnMatch\":\"ParentId\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true,\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Name\"},\"labelSettings\":\"[variables('TemplateEmptyArray')]\"}},\"customWidth\":\"70\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID == \\\"Allowed\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where RequestMethod != \\\"\\\" \\r\\n| where RequestMethod != \\\"None\\\" \\r\\n| summarize count() by RequestMethod \\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Allowed HTTP methods\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where SourceUserPrivileges == \\\"Road Warrior\\\" \\r\\n| summarize URLS_BLOCKED = count() by bin(TimeGenerated, {TimeRange:grain}), Activity\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Block reasons for road warriors\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"name\":\"query - 15\"},{\"type\":1,\"content\":{\"json\":\"---\\r\\n### Block actvities\"},\"name\":\"text - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where SourceUserPrivileges != \\\"\\\" \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| summarize Count = count() by DestinationHostName\\r\\n| top 10 by Count\\r\\n| order by Count desc\",\"size\":0,\"exportFieldName\":\"DestinationHostName\",\"exportParameterName\":\"DestinationHostName\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked domains for HTTP/S requests\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DestinationHostName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\",\"showIcon\":true}}],\"labelSettings\":[{\"columnId\":\"DestinationHostName\",\"label\":\"Destination Host Name\"},{\"columnId\":\"Count\"}]}},\"customWidth\":\"33\",\"name\":\"query - 16\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where SourceUserPrivileges != SourceUserName\\r\\n| summarize Count = count() by SourceUserName\\r\\n| top 10 by Count\\r\\n| order by Count desc\",\"size\":0,\"exportFieldName\":\"SourceUserName\",\"exportParameterName\":\"SourceUserName\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked users for HTTP/S requests\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SourceUserName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\",\"showIcon\":true}}],\"rowLimit\":1000,\"labelSettings\":\"[variables('TemplateEmptyArray')]\"}},\"customWidth\":\"33\",\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| summarize Count = count() by Activity\\r\\n| sort by Count \\r\\n| top 10 by Count\\r\\n\",\"size\":0,\"exportFieldName\":\"Activity\",\"exportParameterName\":\"Activity\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Top Block Reasons for HTTP/S Requests\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Activity\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\",\"showIcon\":true}}],\"labelSettings\":\"[variables('TemplateEmptyArray')]\"}},\"customWidth\":\"33\",\"name\":\"query - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where SourceUserPrivileges != \\\"\\\" \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where (DestinationHostName == '{DestinationHostName}' or '{DestinationHostName}' == \\\"All\\\") and (SourceUserName == '{SourceUserName}' or '{SourceUserName}' == \\\"All\\\") and (Activity == '{Activity}' or '{Activity}' == \\\"All\\\")\\r\\n| summarize Count = count() by DestinationHostName, SourceUserName, Activity, DestinationIP, Location = SourceUserPrivileges\\r\\n| order by Count desc\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Block activities summary\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DestinationHostName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"SourceUserName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Activity\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true,\"labelSettings\":\"[variables('TemplateEmptyArray')]\"}},\"name\":\"query - 14\"}],\"fromTemplateId\":\"sentinel-ZscalerWebOverview\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId4'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=ZscalerWebOverviewWorkbook; logoFileName=zscaler_logo.svg; description=Gain insights into your ZIA web logs by connecting to Microsoft Sentinel.\nThe Zscaler web overview workbook provides a bird's eye view and ability to drill down into all the security and networking events related to web transactions, types of devices, and bandwidth consumption.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.1.0; title=Zscaler Web Overview; templateRelativePath=ZscalerWebOverview.json; subtitle=; provider=Zscaler}.description",
                "parentId": "[variables('workbookId4')]",
                "contentId": "[variables('_workbookContentId4')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Zscaler"
                },
                "support": {
                  "name": "Zscaler",
                  "tier": "Partner",
                  "link": "https://help.zscaler.com/submit-ticket-links"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "CommonSecurityLog",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "Zscaler",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Zscaler Internet Access Analytics Rule 1 with template",
        "displayName": "Zscaler Internet Access Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName1'),'/',variables('analyticRuleVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "DiscordCDNRiskyDownload_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId1')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies callouts to Discord CDN addresses for risky file extensions. This detection will trigger when a callout for a risky file\nis made to a discord server that has only been seen once in your environment. Unique discord servers are identified using the server ID\nthat is included in the request URL (DiscordServerId in query). Discord CDN has been used in multiple campaigns to download additional payloads",
                "displayName": "Discord CDN Risky File Download",
                "enabled": false,
                "query": "let connectionThreshold = 1;\nlet riskyExtensions = dynamic([\".bin\",\".exe\",\".dll\",\".bin\",\".msi\"]);\nCommonSecurityLog\n| where DeviceVendor =~ \"ZScaler\"\n| where RequestURL has_any(\"media.discordapp.net\", \"cdn.discordapp.com\")\n| where RequestURL has \"attachments\"\n| where DeviceAction !~ \"blocked\"\n| extend DiscordServerId = extract(@\"\\/attachments\\/([0-9]+)\\/\", 1, RequestURL)\n| summarize dcount(RequestURL), make_set(SourceUserName), make_set(SourceIP), make_set(RequestURL), min(TimeGenerated), max(TimeGenerated), make_set(DeviceAction) by DiscordServerId, DeviceProduct\n| where dcount_RequestURL <= connectionThreshold\n| mv-expand set_SourceUserName to typeof(string), set_RequestURL to typeof(string), set_DeviceAction to typeof(string), set_SourceIP to typeof(string)\n| summarize by DiscordServerId, DeviceProduct, dcount_RequestURL, set_SourceUserName, min_TimeGenerated, max_TimeGenerated, set_DeviceAction, set_SourceIP, set_RequestURL\n| project StartTime=min_TimeGenerated, EndTime=max_TimeGenerated, DeviceActionTaken=set_DeviceAction, DeviceProduct, SourceUser=set_SourceUserName, SourceIP=set_SourceIP, RequestURL=set_RequestURL\n| where RequestURL has_any (riskyExtensions)\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "CommonSecurityLog"
                    ],
                    "connectorId": "Zscaler"
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "techniques": [
                  "T1071"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SourceUser",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SourceIP",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "RequestURL",
                        "identifier": "Url"
                      }
                    ],
                    "entityType": "URL"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId1'),'/'))))]",
              "properties": {
                "description": "Zscaler Internet Access Analytics Rule 1",
                "parentId": "[variables('analyticRuleId1')]",
                "contentId": "[variables('_analyticRulecontentId1')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Zscaler"
                },
                "support": {
                  "name": "Zscaler",
                  "tier": "Partner",
                  "link": "https://help.zscaler.com/submit-ticket-links"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Zscaler Internet Access Analytics Rule 2 with template",
        "displayName": "Zscaler Internet Access Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName2'),'/',variables('analyticRuleVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "Zscaler-LowVolumeDomainRequests_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId2')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will look for connections to a domain where only a single file is requested, this is unusual as most modern web applications require additional recources. This type of activity is often assocaited with malware beaconing or tracking URL's delivered in emails. Developed for Zscaler but applicable to any outbound web logging.",
                "displayName": "Request for single resource on domain",
                "enabled": false,
                "query": "let scriptExtensions = dynamic([\".php\", \".aspx\", \".asp\", \".cfml\"]);\n//The number of URI's seen to be suspicious, higher = less likely to be suspicious\nlet uriThreshold = 1;\nCommonSecurityLog\n// Only look at connections that were allowed through the web proxy\n| where DeviceVendor =~ \"Zscaler\" and DeviceAction =~ \"Allowed\"\n// Only look where some data was exchanged.\n| where SentBytes > 0 and ReceivedBytes > 0\n// Extract the Domain\n| extend Domain = iff(countof(DestinationHostName,'.') >= 2, strcat(split(DestinationHostName,'.')[-2], '.',split(DestinationHostName,'.')[-1]), DestinationHostName)\n| extend GetData=iff(RequestURL == \"?\", 1, 0)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), makelist(RequestURL), makelist(DestinationIP), makelist(SourceIP), numOfConnections = count(), make_set(RequestMethod), max(GetData), max(RequestContext) by Domain\n// Determine the number of URIs that have been visited for the domain\n| extend destinationURI = arraylength(list_RequestURL)\n| where destinationURI <= uriThreshold\n| where tostring(list_RequestURL) has_any(scriptExtensions)\n//Remove matches with referer\n| where max_RequestContext == \"\"\n//Keep requests where data was trasferred either in a GET with parameters or a POST\n| where set_RequestMethod in~ (\"POST\") or max_GetData == 1\n//Defeat email click tracking, may increase FN's while decreasing FP's\n| where list_RequestURL !has \"click\" and set_RequestMethod !has \"GET\"\n| mvexpand list_RequestURL, list_DestinationIP\n| extend RequestURL = tostring(list_RequestURL), DestinationIP = tostring(list_DestinationIP), ClientIP = tostring(list_SourceIP)\n//Extend custom entitites for incidents\n| extend timestamp = StartTimeUtc, IPCustomEntity = DestinationIP\n| project-away list_RequestURL, list_DestinationIP, list_SourceIP, destinationURI, Domain, StartTimeUtc, EndTimeUtc, max_GetData, max_RequestContext\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "Low",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "CommonSecurityLog"
                    ],
                    "connectorId": "Zscaler"
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "techniques": [
                  "T1102",
                  "T1071"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId2'),'/'))))]",
              "properties": {
                "description": "Zscaler Internet Access Analytics Rule 2",
                "parentId": "[variables('analyticRuleId2')]",
                "contentId": "[variables('_analyticRulecontentId2')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Zscaler"
                },
                "support": {
                  "name": "Zscaler",
                  "tier": "Partner",
                  "link": "https://help.zscaler.com/submit-ticket-links"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('parserTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "properties": {
        "description": "ZScalerFW_Parser Data Parser with template",
        "displayName": "ZScalerFW_Parser Data Parser template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('parserTemplateSpecName1'),'/',variables('parserVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('parserTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "ZScalerFW_Parser Data Parser with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName1')]",
              "apiVersion": "2020-08-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ZScalerFW_Parser",
                "category": "Samples",
                "functionAlias": "ZScalerFW_Parser",
                "query": "\n\r\nCommonSecurityLog\r\n| where DeviceVendor == \"Zscaler\" and DeviceProduct == \"NSSFWlog\"\r\n| extend deviceTranslatedPort = extract(@\"deviceTranslatedPort=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    tunnelType = extract(@\"tunnelType=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    dnat = extract(@\"dnat=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    stateful = extract(@\"stateful=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    reason = coalesce(\r\n                            extract(@\"reason=(.*?)(;|$)\", 1, AdditionalExtensions),                            \r\n                            column_ifexists(\"Reason\", \"\")\r\n                        ),\r\n    DeviceCustomString6Label = extract(@\"cs6label=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    destCountry = extract(@\"destCountry=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    avgduration = extract(@\"avgduration=(.*?)(;|$)\", 1, AdditionalExtensions)\r\n",
                "version": 1,
                "tags": [
                  {
                    "name": "description",
                    "value": "ZScalerFW_Parser"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
              "dependsOn": [
                "[variables('_parserName1')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
                "contentId": "[variables('_parserContentId1')]",
                "kind": "Parser",
                "version": "[variables('parserVersion1')]",
                "source": {
                  "name": "Zscaler Internet Access",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Zscaler"
                },
                "support": {
                  "name": "Zscaler",
                  "tier": "Partner",
                  "link": "https://help.zscaler.com/submit-ticket-links"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2021-06-01",
      "name": "[variables('_parserName1')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "ZScalerFW_Parser",
        "category": "Samples",
        "functionAlias": "ZScalerFW_Parser",
        "query": "\n\r\nCommonSecurityLog\r\n| where DeviceVendor == \"Zscaler\" and DeviceProduct == \"NSSFWlog\"\r\n| extend deviceTranslatedPort = extract(@\"deviceTranslatedPort=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    tunnelType = extract(@\"tunnelType=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    dnat = extract(@\"dnat=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    stateful = extract(@\"stateful=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    reason = coalesce(\r\n                            extract(@\"reason=(.*?)(;|$)\", 1, AdditionalExtensions),                            \r\n                            column_ifexists(\"Reason\", \"\")\r\n                        ),\r\n    DeviceCustomString6Label = extract(@\"cs6label=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    destCountry = extract(@\"destCountry=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    avgduration = extract(@\"avgduration=(.*?)(;|$)\", 1, AdditionalExtensions)\r\n",
        "version": 1
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId1')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
        "contentId": "[variables('_parserContentId1')]",
        "kind": "Parser",
        "version": "[variables('parserVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Zscaler Internet Access",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Zscaler"
        },
        "support": {
          "name": "Zscaler",
          "tier": "Partner",
          "link": "https://help.zscaler.com/submit-ticket-links"
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('parserTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "properties": {
        "description": "ZScalerWeb_Parser Data Parser with template",
        "displayName": "ZScalerWeb_Parser Data Parser template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('parserTemplateSpecName2'),'/',variables('parserVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('parserTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "ZScalerWeb_Parser Data Parser with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName2')]",
              "apiVersion": "2020-08-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ZScalerWeb_Parser",
                "category": "Samples",
                "functionAlias": "ZScalerWeb_Parser",
                "query": "\n\r\nCommonSecurityLog \r\n| where DeviceVendor == \"Zscaler\" and DeviceProduct == \"NSSWeblog\"\r\n| extend reason = coalesce(\r\n                            extract(@\"reason=(.*?)(;|$)\", 1, AdditionalExtensions),                            \r\n                            column_ifexists(\"Reason\", \"\")\r\n                        ),\r\n    user = extract(@\"suser=(.*?);\", 1, AdditionalExtensions),\r\n    sourceIP = extract(@\"sourceTranslatedAddress=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    outcome = coalesce(\r\n                        extract(@\"outcome=(.*?)(;|$)\", 1, AdditionalExtensions),                            \r\n                        column_ifexists(\"EventOutcome\", \"\")\r\n                    ),\r\n    cat = coalesce(\r\n                        extract(@\"cat=(.*?)(;|$)\", 1, AdditionalExtensions),                            \r\n                        column_ifexists(\"DeviceEventCategory\", \"\")\r\n                    ),\r\n    rulelabel = extract(@\"rulelabel=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    ruletype = extract(@\"ruletype=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    urlclass = extract(@\"urlclass=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    devicemodel = extract(@\"devicemodel=(.*?)(;|$)\", 1, AdditionalExtensions)\r\n",
                "version": 1,
                "tags": [
                  {
                    "name": "description",
                    "value": "ZScalerWeb_Parser"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId2'),'/'))))]",
              "dependsOn": [
                "[variables('_parserName2')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName2'))]",
                "contentId": "[variables('_parserContentId2')]",
                "kind": "Parser",
                "version": "[variables('parserVersion2')]",
                "source": {
                  "name": "Zscaler Internet Access",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Zscaler"
                },
                "support": {
                  "name": "Zscaler",
                  "tier": "Partner",
                  "link": "https://help.zscaler.com/submit-ticket-links"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2021-06-01",
      "name": "[variables('_parserName2')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "ZScalerWeb_Parser",
        "category": "Samples",
        "functionAlias": "ZScalerWeb_Parser",
        "query": "\n\r\nCommonSecurityLog \r\n| where DeviceVendor == \"Zscaler\" and DeviceProduct == \"NSSWeblog\"\r\n| extend reason = coalesce(\r\n                            extract(@\"reason=(.*?)(;|$)\", 1, AdditionalExtensions),                            \r\n                            column_ifexists(\"Reason\", \"\")\r\n                        ),\r\n    user = extract(@\"suser=(.*?);\", 1, AdditionalExtensions),\r\n    sourceIP = extract(@\"sourceTranslatedAddress=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    outcome = coalesce(\r\n                        extract(@\"outcome=(.*?)(;|$)\", 1, AdditionalExtensions),                            \r\n                        column_ifexists(\"EventOutcome\", \"\")\r\n                    ),\r\n    cat = coalesce(\r\n                        extract(@\"cat=(.*?)(;|$)\", 1, AdditionalExtensions),                            \r\n                        column_ifexists(\"DeviceEventCategory\", \"\")\r\n                    ),\r\n    rulelabel = extract(@\"rulelabel=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    ruletype = extract(@\"ruletype=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    urlclass = extract(@\"urlclass=(.*?)(;|$)\", 1, AdditionalExtensions),\r\n    devicemodel = extract(@\"devicemodel=(.*?)(;|$)\", 1, AdditionalExtensions)\r\n",
        "version": 1
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId2'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId2')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName2'))]",
        "contentId": "[variables('_parserContentId2')]",
        "kind": "Parser",
        "version": "[variables('parserVersion2')]",
        "source": {
          "kind": "Solution",
          "name": "Zscaler Internet Access",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Zscaler"
        },
        "support": {
          "name": "Zscaler",
          "tier": "Partner",
          "link": "https://help.zscaler.com/submit-ticket-links"
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AzureFunction"
      },
      "properties": {
        "description": "FunctionApp",
        "displayName": "FunctionApp"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName1'),'/',variables('playbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AzureFunction"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "FunctionApp Playbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "Storage account name": {
              "defaultValue": "zscalerauthenticationsa",
              "type": "String",
              "metadata": {
                "description": "Name of the storage account, which will be created by the playbook."
              }
            },
            "Keyvault name": {
              "defaultValue": "zscalerauthenticationkv",
              "type": "String",
              "metadata": {
                "description": "Name of the Azure Keyvault, which will be created by the playbook. A vault's name must be between 3-24 alphanumeric characters. The name must begin with a letter, end with a letter or digit, and not contain consecutive hyphens."
              }
            },
            "FunctionAppname": {
              "defaultValue": "zscalerauthenticationfa",
              "type": "String",
              "metadata": {
                "description": "Name of the Azure Function App, which will be created by the playbook."
              }
            },
            "Zscaler Key": {
              "defaultValue": "",
              "type": "securestring",
              "metadata": {
                "description": "Your Zscaler key."
              }
            },
            "Zscaler Username": {
              "defaultValue": "",
              "type": "securestring",
              "metadata": {
                "description": "Your Zscaler username."
              }
            },
            "Zscaler Password": {
              "defaultValue": "",
              "type": "securestring",
              "metadata": {
                "description": "Your Zscaler password."
              }
            }
          },
          "variables": {
            "functionAppName": "[[parameters('FunctionAppname')]",
            "appServicePlanName": "[[parameters('FunctionAppname')]",
            "keyvault_name": "[[toLower(parameters('Keyvault name'))]",
            "storageAccountName": "[[toLower(parameters('Storage account name'))]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId1": "FunctionApp",
            "playbookId1": "[[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2016-10-01",
              "name": "[[variables('keyvault_name')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[[subscription().tenantId]",
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": true,
                "enableSoftDelete": true,
                "accessPolicies": "[variables('TemplateEmptyArray')]"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2016-10-01",
              "name": "[[concat(variables('keyvault_name'), '/', 'Zscaler-Key')]",
              "dependsOn": [
                "[[resourceId('Microsoft.KeyVault/vaults', variables('keyvault_name'))]"
              ],
              "properties": {
                "value": "[[parameters('Zscaler Key')]",
                "contentType": "string",
                "attributes": {
                  "enabled": true
                }
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2016-10-01",
              "name": "[[concat(variables('keyvault_name'), '/', 'Zscaler-Username')]",
              "dependsOn": [
                "[[resourceId('Microsoft.KeyVault/vaults', variables('keyvault_name'))]"
              ],
              "properties": {
                "value": "[[parameters('Zscaler Username')]",
                "contentType": "string",
                "attributes": {
                  "enabled": true
                }
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2016-10-01",
              "name": "[[concat(variables('keyvault_name'), '/', 'Zscaler-Password')]",
              "dependsOn": [
                "[[resourceId('Microsoft.KeyVault/vaults', variables('keyvault_name'))]"
              ],
              "properties": {
                "value": "[[parameters('Zscaler Password')]",
                "contentType": "string",
                "attributes": {
                  "enabled": true
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "name": "[[variables('storageAccountName')]",
              "apiVersion": "2021-01-01",
              "location": "[[variables('workspace-location-inline')]",
              "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
              },
              "kind": "StorageV2"
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2018-11-01",
              "name": "[[variables('functionAppName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "functionapp",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/serverfarms',variables('appServicePlanName'))]"
              ],
              "properties": {
                "enabled": true,
                "hostNameSslStates": [
                  {
                    "name": "[[concat(variables('functionAppName'), '.azurewebsites.net')]",
                    "sslState": "Disabled",
                    "hostType": "Standard"
                  },
                  {
                    "name": "[[concat(variables('functionAppName'), '.scm.azurewebsites.net')]",
                    "sslState": "Disabled",
                    "hostType": "Repository"
                  }
                ],
                "serverFarmId": "[[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "reserved": false,
                "isXenon": false,
                "hyperV": false,
                "scmSiteAlsoStopped": false,
                "clientAffinityEnabled": false,
                "clientCertEnabled": false,
                "hostNamesDisabled": false,
                "containerSize": 1536,
                "dailyMemoryTimeQuota": 0,
                "httpsOnly": false,
                "redundancyMode": "None"
              }
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2018-11-01",
              "name": "[[concat(variables('functionAppName'), '/web')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/sites', variables('functionAppName'))]",
                "[[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "[[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ],
              "properties": {
                "numberOfWorkers": 1,
                "defaultDocuments": [
                  "Default.htm",
                  "Default.html",
                  "Default.asp",
                  "index.htm",
                  "index.html",
                  "iisstart.htm",
                  "default.aspx",
                  "index.php"
                ],
                "netFrameworkVersion": "v4.0",
                "phpVersion": "5.6",
                "requestTracingEnabled": false,
                "remoteDebuggingEnabled": false,
                "httpLoggingEnabled": false,
                "logsDirectorySizeLimit": 35,
                "detailedErrorLoggingEnabled": false,
                "publishingUsername": "$zsacler-fa",
                "scmType": "None",
                "use32BitWorkerProcess": true,
                "webSocketsEnabled": false,
                "alwaysOn": false,
                "managedPipelineMode": "Integrated",
                "virtualApplications": [
                  {
                    "virtualPath": "/",
                    "physicalPath": "site\\wwwroot",
                    "preloadEnabled": false
                  }
                ],
                "loadBalancing": "LeastRequests",
                "experiments": {
                  "rampUpRules": "[variables('TemplateEmptyArray')]"
                },
                "autoHealEnabled": false,
                "cors": {
                  "allowedOrigins": [
                    "https://functions.azure.com",
                    "https://functions-staging.azure.com",
                    "https://functions-next.azure.com"
                  ],
                  "supportCredentials": false
                },
                "localMySqlEnabled": false,
                "ipSecurityRestrictions": [
                  {
                    "ipAddress": "Any",
                    "action": "Allow",
                    "priority": 1,
                    "name": "Allow all",
                    "description": "Allow all access"
                  }
                ],
                "scmIpSecurityRestrictions": [
                  {
                    "ipAddress": "Any",
                    "action": "Allow",
                    "priority": 1,
                    "name": "Allow all",
                    "description": "Allow all access"
                  }
                ],
                "scmIpSecurityRestrictionsUseMain": false,
                "http20Enabled": false,
                "minTlsVersion": "1.2",
                "ftpsState": "AllAllowed",
                "reservedInstanceCount": 0
              }
            },
            {
              "type": "Microsoft.Web/sites/functions",
              "apiVersion": "2018-11-01",
              "name": "[[concat(variables('functionAppName'), '/GetApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/sites', variables('functionAppName'))]",
                "[[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "[[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ],
              "properties": {
                "config": {
                  "bindings": [
                    {
                      "authLevel": "anonymous",
                      "name": "req",
                      "type": "httpTrigger",
                      "direction": "in"
                    },
                    {
                      "name": "res",
                      "type": "http",
                      "direction": "out"
                    }
                  ]
                },
                "files": {
                  "index.js": "module.exports = function (context, data) {  var input = data;    var timestamp = Date.now().toString();    var high = timestamp.substring(timestamp.length - 6);    var low = (parseInt(high) >> 1).toString();    var apiKey = '';    while (low.length < 6) {    low = '0' + low;    }    for (var i = 0; i < high.length; i++) {    apiKey += input.body.key.charAt(parseInt(high.charAt(i)));    }    for (var j = 0; j < low.length; j++) {    apiKey += input.body.key.charAt(parseInt(low.charAt(j)) + 2);    }    context.res = {    body: {      apiKey: apiKey,      timestamp: timestamp    }  };  context.done();};"
                }
              }
            },
            {
              "type": "Microsoft.Web/sites/hostNameBindings",
              "apiVersion": "2018-11-01",
              "name": "[[concat(variables('functionAppName'), '/', variables('functionAppName'), '.azurewebsites.net')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/sites', variables('functionAppName'))]",
                "[[resourceId('Microsoft.Web/serverfarms',variables('appServicePlanName'))]"
              ],
              "properties": {
                "siteName": "zsacler-fa",
                "hostNameType": "Verified"
              }
            },
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2018-02-01",
              "name": "[[variables('appServicePlanName')]",
              "location": "[[variables('workspace-location-inline')]",
              "sku": {
                "name": "Y1",
                "tier": "Dynamic"
              },
              "kind": "functionapp",
              "properties": {
                "name": "[[variables('appServicePlanName')]",
                "workerSize": "0",
                "workerSizeId": "0",
                "numberOfWorkers": "1"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('AzureFunction-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "AzureFunction",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Zscaler"
                },
                "support": {
                  "name": "Zscaler",
                  "tier": "Partner",
                  "link": "https://help.zscaler.com/submit-ticket-links"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Zscaler-Authentication-Playbook playbook",
        "displayName": "Zscaler-Authentication-Playbook playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName2'),'/',variables('playbookVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "Zscaler-Authentication-Playbook Playbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Authentication-Playbook",
              "type": "String",
              "metadata": {
                "description": "Name of the playbook, used as name for the resources. Use only letters and dashes."
              }
            },
            "Keyvault name": {
              "defaultValue": "zscalerauthenticationkv",
              "type": "String",
              "metadata": {
                "description": "Name of the Azure Keyvault, which will be created by the playbook. A vault's name must be between 3-24 alphanumeric characters. The name must begin with a letter, end with a letter or digit, and not contain consecutive hyphens."
              }
            },
            "FunctionAppname": {
              "defaultValue": "zscalerauthenticationfa",
              "type": "String",
              "metadata": {
                "description": "Name of the Azure Function App, which will be created by the playbook."
              }
            },
            "Zscaler Admin Url": {
              "defaultValue": "https://admin.<zscaler_instance_domain>.net",
              "type": "string",
              "metadata": {
                "description": "Update to a valid Zscaler admin url."
              }
            }
          },
          "variables": {
            "functionAppName": "[[parameters('FunctionAppname')]",
            "keyvault_name": "[[toLower(parameters('Keyvault name'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/keyvault')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('keyvault_name')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": "[variables('TemplateEmptyArray')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                },
                "parameterValues": {
                  "token:TenantId": "[[subscription().tenantId]",
                  "token:grantType": "code",
                  "vaultName": "[[variables('KeyVault_name')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('keyvault_name'))]"
              ],
              "tags": {
                "hidden-SentinelTemplateName": "Zscaler-Authentication",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "manual": {
                      "type": "Request",
                      "kind": "Http"
                    }
                  },
                  "actions": {
                    "GetApiKey": {
                      "runAfter": {
                        "Get_Zscaler_Password": [
                          "Succeeded"
                        ]
                      },
                      "type": "Function",
                      "inputs": {
                        "body": {
                          "key": "@body('Get_Zscaler_Key')?['value']"
                        },
                        "function": {
                          "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/', variables('functionAppName'), '/functions/GetApiKey')]"
                        }
                      }
                    },
                    "Get_Zscaler_Key": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['keyvault']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/secrets/@{encodeURIComponent('Zscaler-Key')}/value"
                      },
                      "runtimeConfiguration": {
                        "secureData": {
                          "properties": [
                            "outputs"
                          ]
                        }
                      }
                    },
                    "Get_Zscaler_Username": {
                      "runAfter": {
                        "Get_Zscaler_Key": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['keyvault']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/secrets/@{encodeURIComponent('Zscaler-Username')}/value"
                      },
                      "runtimeConfiguration": {
                        "secureData": {
                          "properties": [
                            "outputs"
                          ]
                        }
                      }
                    },
                    "Get_Zscaler_Password": {
                      "runAfter": {
                        "Get_Zscaler_Username": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['keyvault']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/secrets/@{encodeURIComponent('Zscaler-Password')}/value"
                      },
                      "runtimeConfiguration": {
                        "secureData": {
                          "properties": [
                            "outputs"
                          ]
                        }
                      }
                    },
                    "HTTP": {
                      "runAfter": {
                        "Parse_Response": [
                          "Succeeded"
                        ]
                      },
                      "type": "Http",
                      "inputs": {
                        "body": {
                          "apiKey": "@{body('Parse_Response')?['apiKey']}",
                          "password": "@{body('Get_Zscaler_Password')?['value']}",
                          "timestamp": "@{body('Parse_Response')?['timestamp']}",
                          "username": "@{body('Get_Zscaler_Username')?['value']}"
                        },
                        "headers": {
                          "Cache-Control": "no-cache",
                          "Content-Type": "application/json"
                        },
                        "method": "POST",
                        "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), 'api/v1/authenticatedSession'))]"
                      }
                    },
                    "Parse_Headers": {
                      "runAfter": {
                        "HTTP": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@outputs('HTTP')['headers']",
                        "schema": {
                          "properties": {
                            "Connection": {
                              "type": "string"
                            },
                            "Content-Length": {
                              "type": "string"
                            },
                            "Content-Type": {
                              "type": "string"
                            },
                            "Date": {
                              "type": "string"
                            },
                            "Keep-Alive": {
                              "type": "string"
                            },
                            "Server": {
                              "type": "string"
                            },
                            "Set-Cookie": {
                              "type": "string"
                            },
                            "Strict-Transport-Security": {
                              "type": "string"
                            },
                            "X-Content-Type-Options": {
                              "type": "string"
                            },
                            "X-Frame-Options": {
                              "type": "string"
                            },
                            "X-XSS-Protection": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "Parse_Response": {
                      "runAfter": {
                        "GetApiKey": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('GetApiKey')",
                        "schema": {
                          "properties": {
                            "apiKey": {
                              "type": "string"
                            },
                            "timestamp": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "Response": {
                      "runAfter": {
                        "Parse_Headers": [
                          "Succeeded"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "cookie": "@{body('Parse_Headers')?['Set-Cookie']}"
                        },
                        "headers": "@outputs('HTTP')['headers']",
                        "statusCode": "@outputs('HTTP')['statusCode']"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "keyvault": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('keyvault_name'))]",
                        "connectionName": "keyvault",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId ,'/providers/Microsoft.Web/locations/', variables('workspace-location-inline') ,'/managedApis/keyvault')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Zscaler"
                },
                "support": {
                  "name": "Zscaler",
                  "tier": "Partner",
                  "link": "https://help.zscaler.com/submit-ticket-links"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "AzureFunction",
                      "contentId": "[variables('_FunctionApp')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Zscaler API authentication",
            "description": "This playbook generates access token in Zscaler API. Call this playbook as a step in functional Zscaler playbooks. The output is a JSessionID which can be used to do other API actions",
            "prerequisites": [
              "Playbook templates leverage the Zscaler API. To use the Zscaler capabilities, you need a Zscaler API key. Refer this link: [API Developers Guide: Getting Started](https://help.zscaler.com/zia/api-getting-started)",
              "Please deploy the function app before the Zscaler API authentication playbook."
            ],
            "lastUpdateTime": "2021-07-28T00:00:00Z",
            "tags": [
              "Utilities"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Zscaler-Add-Url-To-Category playbook",
        "displayName": "Zscaler-Add-Url-To-Category playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName3'),'/',variables('playbookVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "Zscaler-Add-Url-To-Category Playbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Add-Url-To-Category",
              "type": "String",
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "Zscaler Authentation Playbook": {
              "defaultValue": "Zscaler-Authentication-Playbook",
              "type": "String",
              "metadata": {
                "description": "Name of the Zscaler Authentication Playbook"
              }
            },
            "Zscaler Admin Url": {
              "defaultValue": "https://admin.<zscaler_instance_domain>.net",
              "type": "string",
              "metadata": {
                "description": "Update to a valid Zscaler admin url."
              }
            },
            "Block Category": {
              "defaultValue": "OTHER_MISCELLANEOUS",
              "type": "String",
              "metadata": {
                "description": "Zscaler block category"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler Authentation Playbook'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "identity": {
                "type": "SystemAssigned"
              },
              "tags": {
                "hidden-SentinelTemplateName": "BlockURL-Zscaler",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Set_Zscaler_Block_Category": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Category",
                            "type": "string",
                            "value": "[[parameters('Block Category')]"
                          }
                        ]
                      }
                    },
                    "Entities_-_Get_URLs": {
                      "runAfter": {
                        "Set_Zscaler_Block_Category": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/url"
                      }
                    },
                    "For_each": {
                      "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "runAfter": {
                            "Compose": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "[[concat('<p>@{outputs(''Compose'')}<br>Url @{items(''For_each'')?[''Url'']} has been added to category @{variables(''Category'')}</p>')]"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          }
                        },
                        "Compose": {
                          "runAfter": {
                            "HTTP_Activate_Changes": [
                              "Succeeded"
                            ]
                          },
                          "type": "Compose",
                          "inputs": "<img src=\"https://www.zscaler.com//themes/custom/zscaler/logo.svg\" alt=\"Zscaler\">"
                        },
                        "HTTP_Add_Url": {
                          "type": "Http",
                          "inputs": {
                            "body": {
                              "configuredName": "@{variables('Category')}",
                              "urls": [
                                "@{items('For_each')?['Url']}"
                              ]
                            },
                            "cookie": "@body('Parse_Authentication_Response')?['cookie']",
                            "headers": {
                              "Cache-Control": "no-cache",
                              "Content-Type": "application/json"
                            },
                            "method": "PUT",
                            "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), 'api/v1/urlCategories/@{variables(''Category'')}?action=ADD_TO_LIST'))]"
                          }
                        },
                        "HTTP_Activate_Changes": {
                          "runAfter": {
                            "HTTP_Add_Url": [
                              "Succeeded"
                            ]
                          },
                          "type": "Http",
                          "inputs": {
                            "cookie": "@body('Parse_Authentication_Response')?['cookie']",
                            "method": "POST",
                            "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), 'api/v1/status/activate'))]"
                          }
                        }
                      },
                      "runAfter": {
                        "Parse_Authentication_Response": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "HTTP_Delete_Api_Session": {
                      "runAfter": {
                        "For_each": [
                          "Succeeded"
                        ]
                      },
                      "type": "Http",
                      "inputs": {
                        "cookie": "@body('Parse_Authentication_Response')?['cookie']",
                        "method": "DELETE",
                        "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), 'api/v1/authenticatedSession'))]"
                      }
                    },
                    "Parse_Authentication_Response": {
                      "runAfter": {
                        "zscaler": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('zscaler')",
                        "schema": {
                          "properties": {
                            "cookie": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "zscaler": {
                      "runAfter": {
                        "Entities_-_Get_URLs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "triggerName": "manual",
                          "workflow": {
                            "id": "[[variables('ZscalerAuthenticationFlow')]"
                          }
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Zscaler"
                },
                "support": {
                  "name": "Zscaler",
                  "tier": "Partner",
                  "link": "https://help.zscaler.com/submit-ticket-links"
                }
              }
            }
          ],
          "metadata": {
            "title": "Block URL - Zscaler",
            "description": "This playbook allows blocks URLs in Zscaler by adding them to categories",
            "prerequisites": [
              "1. This playbook leverages a nested playbook: Zscaler authentication. The **Zscaler-Authentication-Playbook** can be deployed using below steps:\n\n 1. Using direct ARM template (github)\n\n 2. By navigating to Automation --> Playbook templates --> ZScalar Authentication",
              "2. Create a block category in Zscaler, which this playbook will add IPs to."
            ],
            "lastUpdateTime": "2021-07-28T00:00:00Z",
            "entities": [
              "Url"
            ],
            "tags": [
              "Remediation"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Zscaler-Get-Sandbox-Report-For-Hash playbook",
        "displayName": "Zscaler-Get-Sandbox-Report-For-Hash playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName4'),'/',variables('playbookVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "Zscaler-Get-Sandbox-Report-For-Hash Playbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Get-Sandbox-Report-For-Hash",
              "type": "String",
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "Zscaler Authentation Playbook": {
              "defaultValue": "Zscaler-Authentication-Playbook",
              "type": "String",
              "metadata": {
                "description": "Name of the Zscaler Authentication Playbook"
              }
            },
            "Zscaler Admin Url": {
              "defaultValue": "https://admin.<zscaler_instance_domain>.net",
              "type": "string",
              "metadata": {
                "description": "Update to a valid Zscaler admin url."
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler Authentation Playbook'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "FileHashEnrichment-Zscaler",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_FileHashes": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/filehash"
                      }
                    },
                    "For_each": {
                      "foreach": "@body('Entities_-_Get_FileHashes')?['Filehashes']",
                      "actions": {
                        "Append_to_Result_variable": {
                          "runAfter": {
                            "Parse_Result": [
                              "Succeeded"
                            ]
                          },
                          "type": "AppendToStringVariable",
                          "inputs": {
                            "name": "Result",
                            "value": "Summary: @{body('Parse_Result')?['Summary']}<br/>"
                          }
                        },
                        "Compose": {
                          "runAfter": {
                            "Append_to_Result_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "Compose",
                          "inputs": "<img src=\"https://www.zscaler.com//themes/custom/zscaler/logo.svg\" alt=\"Zscaler\">"
                        },
                        "Add_comment_to_incident_(V3)": {
                          "runAfter": {
                            "Compose": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>@{outputs('Compose')}<br>\nFileHash report from Zscaler playbook:<br>\n<br>\nSummary:<br>\nStatus: @{body('Parse_Result')?['Summary']?['Summary']?['Status']}<br>\nCategory: @{body('Parse_Result')?['Summary']?['Summary']?['Category']}<br>\nFileType: @{body('Parse_Result')?['Summary']?['Summary']?['FileType']}<br>\n<br>\nClassification:<br>\nType: @{body('Parse_Result')?['Summary']?['Classification']?['Type']}<br>\nCategory: @{body('Parse_Result')?['Summary']?['Classification']?['Category']}<br>\nScore: @{body('Parse_Result')?['Summary']?['Classification']?['Score']}<br>\nDetected Malware: @{body('Parse_Result')?['Summary']?['Classification']?['DetectedMalware']}<br>\n<br>\nFile properties:<br>\nFile type: @{body('Parse_Result')?['Summary']?['FileProperties']?['FileType']}<br>\nFile size: @{body('Parse_Result')?['Summary']?['FileProperties']?['FileSize']}<br>\nMD5: @{body('Parse_Result')?['Summary']?['FileProperties']?['MD5']}<br>\nSHA1: @{body('Parse_Result')?['Summary']?['FileProperties']?['SHA1']}<br>\nSha256: @{body('Parse_Result')?['Summary']?['FileProperties']?['Sha256']}<br>\nIssuer: @{body('Parse_Result')?['Summary']?['FileProperties']?['Issuer']}<br>\nDigital certificate: @{body('Parse_Result')?['Summary']?['FileProperties']?['DigitalCerificate']}<br>\nSSDeep: @{body('Parse_Result')?['Summary']?['FileProperties']?['SSDeep']}<br>\nRootCA: @{body('Parse_Result')?['Summary']?['FileProperties']?['RootCA']}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          }
                        },
                        "HTTP": {
                          "type": "Http",
                          "inputs": {
                            "cookie": "@body('Parse_Authentication_Response')?['cookie']",
                            "headers": {
                              "Cache-Control": "no-cache",
                              "Content-Type": "application/json"
                            },
                            "method": "GET",
                            "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), 'api/v1/sandbox/report/@{items(''For_each'')?[''Value'']}?details=summary'))]"
                          }
                        },
                        "Parse_Result": {
                          "runAfter": {
                            "HTTP": [
                              "Succeeded"
                            ]
                          },
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@body('HTTP')",
                            "schema": {
                              "properties": {
                                "Summary": {
                                  "properties": {
                                    "Classification": {
                                      "properties": {
                                        "Category": {
                                          "type": "string"
                                        },
                                        "DetectedMalware": {
                                          "type": "string"
                                        },
                                        "Score": {
                                          "type": "integer"
                                        },
                                        "Type": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    },
                                    "FileProperties": {
                                      "properties": {
                                        "DigitalCerificate": {
                                          "type": "string"
                                        },
                                        "FileSize": {
                                          "type": "integer"
                                        },
                                        "FileType": {
                                          "type": "string"
                                        },
                                        "Issuer": {
                                          "type": "string"
                                        },
                                        "MD5": {
                                          "type": "string"
                                        },
                                        "RootCA": {
                                          "type": "string"
                                        },
                                        "SHA1": {
                                          "type": "string"
                                        },
                                        "SSDeep": {
                                          "type": "string"
                                        },
                                        "Sha256": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    },
                                    "Summary": {
                                      "properties": {
                                        "Category": {
                                          "type": "string"
                                        },
                                        "Duration": {
                                          "type": "integer"
                                        },
                                        "FileType": {
                                          "type": "string"
                                        },
                                        "StartTime": {
                                          "type": "integer"
                                        },
                                        "Status": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  },
                                  "type": "object"
                                }
                              },
                              "type": "object"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Initialize_Response_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "HTTP_Delete_Api_Session": {
                      "runAfter": {
                        "For_each": [
                          "Succeeded"
                        ]
                      },
                      "type": "Http",
                      "inputs": {
                        "cookie": "@body('Parse_Authentication_Response')?['cookie']",
                        "method": "DELETE",
                        "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), 'api/v1/authenticatedSession'))]"
                      }
                    },
                    "Initialize_Response_variable": {
                      "runAfter": {
                        "Parse_Authentication_Response": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Result",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "Parse_Authentication_Response": {
                      "runAfter": {
                        "zscaler": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('zscaler')",
                        "schema": {
                          "properties": {
                            "cookie": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "zscaler": {
                      "runAfter": {
                        "Entities_-_Get_FileHashes": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "triggerName": "manual",
                          "workflow": {
                            "id": "[[variables('ZscalerAuthenticationFlow')]"
                          }
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Zscaler"
                },
                "support": {
                  "name": "Zscaler",
                  "tier": "Partner",
                  "link": "https://help.zscaler.com/submit-ticket-links"
                }
              }
            }
          ],
          "metadata": {
            "title": "FileHash Enrichment - Zscaler",
            "description": "This playbook post a Zscaler Sandbox report for each FileHash found in the incident.",
            "prerequisites": [
              "1. This playbook leverages a nested playbook: Zscaler authentication. The **Zscaler-Authentication-Playbook** can be deployed using below steps:\n\n 1. Using direct ARM template (github)\n\n 2. By navigating to Automation --> Playbook templates --> ZScalar Authentication",
              "2. Create a block category in Zscaler, which this playbook will add IPs to."
            ],
            "lastUpdateTime": "2021-07-28T00:00:00Z",
            "entities": [
              "FileHash"
            ],
            "tags": [
              "Enrichment"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "2.0.2",
        "kind": "Solution",
        "contentSchemaVersion": "2.0.0",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Zscaler Internet Access",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Zscaler"
        },
        "support": {
          "name": "Zscaler",
          "tier": "Partner",
          "link": "https://help.zscaler.com/submit-ticket-links"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId2')]",
              "version": "[variables('workbookVersion2')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId3')]",
              "version": "[variables('workbookVersion3')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId4')]",
              "version": "[variables('workbookVersion4')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId1')]",
              "version": "[variables('analyticRuleVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId2')]",
              "version": "[variables('analyticRuleVersion2')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_parserContentId1')]",
              "version": "[variables('parserVersion1')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_parserContentId2')]",
              "version": "[variables('parserVersion2')]"
            },
            {
              "kind": "AzureFunction",
              "contentId": "[variables('_FunctionApp')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Zscaler API authentication')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Add-Url-To-Category')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Get-Sandbox-Report-For-Hash')]",
              "version": "[variables('playbookVersion4')]"
            }
          ]
        },
        "firstPublishDate": "2022-05-25",
        "providers": [
          "Zscaler"
        ],
        "categories": {
          "domains": [
            "Security - Network",
            "Security - Cloud Security"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
